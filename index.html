<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.10/css/all.css" integrity="sha384-+d0P83n9kaQMCwj8F4RJB66tzIwOKmrdb46+porD/OvrJ+37WqIM7UoBtwHO6Nlg" crossorigin="anonymous">

    <title>Site Checker</title>

    <style>
      .l-header .title {
        font-size: 1.5rem;
      }
      .window-box iframe {
        width: 100%;
        height: 50vw;
      }
      .window-box .close-btn {
        position: absolute;
        top: 0;
        right: 0;
        display: inline-block;
        cursor: pointer;
        z-index: 1;
        background-color: transparent;
      }
    </style>

  </head>
  <body>
    <div id="app">
      <header class="bg-primary text-white mb-2">
        <div class="l-header container-fluid py-2">
          <div class="d-flex d-flex justify-content-between">
            <!-- left column -->
            <div class="l-header-left">
              <div class="title"><a class="text-white" href="/">Site Checker</a></div>
            </div>
            <!-- left column -->
            <div class="l-header-right">
              <div class="form-inline">
                  <div class="form-group">
                    <input type="text" class="form-control mx-2" name="url" placeholder="Input URL" @keyup.enter="add" v-model="inputUrl">
                  </div>
              </div>
            </div>
          </div>
        </div>
      </header>
      <div class="container-fluid">
          <div class="row">
              <window v-for="window in windows" :key="window.url" :url="window.url" :duration="window.duration" @remove="remove"></window>
          </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script>
      Vue.component('window', {
        template: '<div class="window-box col-6">\
                      <div class="card mb-3 position-relative">\
                          <button class="btn close-btn text-secondary" @click.prevent="$emit(\'remove\', url)"><i class="fas fa-times fa-3x"></i></button>\
                          <div class="card-body">\
                            <h5 class="card-title">{{ url }}</h5>\
                            <div>Duration <span class="badge badge-secondary">{{ duration }}</span></div>\
                            <div>Reflesh Timer <span class="badge badge-success">{{ remainTime }}</span></div>\
                          </div>\
                          <iframe :src="url" frameborder="0" @load="setReflesh"></iframe>\
                      </div>\
                  </div>',
        props: ['url', 'duration'],
        data: function(){
          return {
            url: '',
            duration: '',
            refleshAt: 1000 * 60,
            timers: []
          }
        },
        methods: {
          setReflesh: function(event) {
            let iframeElement = event.target;
            let self = this;
            // 既にタイマーが作動してないかチェック
            if (self.timers[self.url]) {
              return;
            }
            // 1秒毎にrefleshAtを減らして、0になったら更新
            self.timers[self.url] = setInterval(function(){
              self.refleshAt = self.refleshAt - 1000;
              if (self.refleshAt <= 0) {
                // リフレッシュ
                iframeElement.src = self.url;
                // タイマーリセット
                self.refleshAt = self.duration;
                clearInterval(self.timers[self.url]);
                self.timers[self.url] = null;
              }
            }, 1000);
          }
        }, 
        computed: {
          remainTime: function() {
            return this.refleshAt / 1000;
          }
        }
      })

      var app = new Vue({
        el: '#app',
        data: {
          windows: [],
          inputUrl: ''
        },
        methods: {
          add: function(){
            console.log("addWindow");
            let windowData = {
              url: this.inputUrl,
              duration: 1000 * 60,
            }
            windowData.refleshAt = windowData.duration

            this.windows.push(windowData);
            this.inputUrl = '';
          }, 
          remove: function(url){
            console.log('remove', url)
            this.windows.splice(this.windows.indexOf(url), 1)
          }
        }
      })
    </script>
  </body>
</html>
